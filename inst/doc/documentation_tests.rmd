
## Dependances
```{r setup, message=FALSE}
# packages
library(readxl)
library(lubridate)
library(tidyverse)
library(rvle)
library(rsunflo)
```


## Plannification

### Création du plan d'expérience (rsunflo)
```{r design_rsunflo}
# Import des données
## Essais (n=2)
trials <- read_xlsx("inst/doc/files/design.xlsx", sheet="trials")
## Genotypes (n=3)
genotypes <- read_xlsx("inst/doc/files/design.xlsx", sheet="genotype")

# Plan factoriel complet
design <- crossing(trial_id=trials$trial_id, genotype=genotypes$genotype)
design <- design %>% left_join(trials) %>% left_join(genotypes)

# Mise en forme au format rsunflo
duration_soil = days(5) # durée (j) de la période de simulation sans culture

design <- design %>%
  mutate(
    id = 1:n(),
    begin = crop_sowing - duration_soil,
    end = crop_harvest + duration_soil,
    duration = as.numeric(end - begin),
    file = paste("DB/files_test/",trial_id,".txt",sep="")
  ) 

# export design
saveRDS(design, "inst/doc/files/design.rds")
```



## Simulation

```{r simulation_rsunflo}
# packages
library(rvle)

# chargement du plan d'experience
design <- readRDS("inst/doc/files/design.rds")

# Modèle et plan
sunflo <- new("Rvle", file = "sunflo_web.vpz", pkg = "sunflo")
design_vle <- as.list(design)

# Paramétrisation par défaut
sunflo %>% run() %>% results() %>% shape(view="timed")

# Paramétrisation issue du plan d'expérience (1 unité de simulation)
design %>% play(unit=1) %>% shape(view="timed")

# Sortie graphique
sunflo %>% play(design_vle, unit=1) %>% shape(view="timed") %>% display()

# Multi-simulation du plan d'expérience (parallélisation possible : require(doMC), ?mlply)
model <- function(id){sunflo %>% play(design_vle, unit=match(id, design_vle$id)) %>% shape(view="timed")}

list_simulation <- design %>% select(id) 
output <- plyr::mlply(list_simulation, failwith(NULL, model))

# Agregation (1 unité -> une matrice)
output_timed <- output %>% compact() %>% ldply(.id="id")

# Calcul d'indicateurs (1 unité -> un vecteur)
output_indicators <- output %>% compact() %>% ldply(indicate, .id="id")
```


```{r simulation_debug, eval=FALSE}
library(rvle)

# Modèle et plan
sunflo <- new("Rvle", file = "sunflo_web.vpz", pkg = "sunflo")

# load reference simulation (SUNFLO v1.2, VLE 1.0.3)
output_ref <- readRDS("inst/doc/files/output_ref.rds") %>%
  rename(PET=ETP, ETPET=ETRETM) %>% 
  gather(variable, value_ref, -time) 

# run current model
output_new <- sunflo %>% run() %>% results() %>% shape(view="timed") %>%
  gather(variable, value_new, -time)

# plot differences, test : identical(output_ref, output_new)
plot_dynamics <- left_join(output_ref, output_new) %>% 
  gather(version, value, -time, -variable) %>% 
  ggplot(aes(time, value, color=version)) +
  geom_line() +
  facet_wrap(~ variable, scale="free")

```


## Analyse
```{r analysis, eval=FALSE}
# test model evaluation and visualization

data_test <- data_frame(
  model=c(rep(LETTERS[1:2],each=500)),
  simulated=rnorm(1000),
  observed=rnorm(1000)
)

data_test %>% group_by(model) %>% do(evaluate_error(.))

data_test %>% evaluate_plot(~ model, color="model")

data_test %>% evaluate_residuals(~ model, color="model")

```
